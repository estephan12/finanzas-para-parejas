rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isGroupMember(groupId) {
      return isAuthenticated() && 
             request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
    }
    
    function isValidTransaction() {
      return request.resource.data.keys().hasAll(['type', 'category', 'amount', 'date', 'paidBy', 'private']) &&
             request.resource.data.type in ['income', 'expense'] &&
             request.resource.data.amount is number &&
             request.resource.data.amount > 0 &&
             request.resource.data.private is bool;
    }
    
    function isValidGoal() {
      return request.resource.data.keys().hasAll(['name', 'targetAmount', 'currentAmount', 'deadline']) &&
             request.resource.data.targetAmount is number &&
             request.resource.data.targetAmount > 0 &&
             request.resource.data.currentAmount is number &&
             request.resource.data.currentAmount >= 0;
    }
    
    function isValidDebt() {
      return request.resource.data.keys().hasAll(['name', 'balance', 'interestRate']) &&
             request.resource.data.balance is number &&
             request.resource.data.balance >= 0 &&
             request.resource.data.interestRate is number &&
             request.resource.data.interestRate >= 0 &&
             request.resource.data.interestRate <= 1;
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read and write their own document
      allow read, write: if isOwner(userId);
      
      // Users can create their own document during registration
      allow create: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Groups collection
    match /groups/{groupId} {
      // Group members can read group data
      allow read: if isGroupMember(groupId);
      
      // Authenticated users can create groups (they become first member)
      allow create: if isAuthenticated() && 
                       request.resource.data.members.size() == 1 &&
                       request.auth.uid in request.resource.data.members;
      
      // Group members can update group (e.g., add second member)
      allow update: if isGroupMember(groupId) &&
                       // Cannot remove yourself if you're the last member
                       (request.resource.data.members.size() > 0) &&
                       // Can only add/remove members, not change other fields arbitrarily
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members', 'settings']);
      
      // Only allow delete if user is a member (soft delete recommended instead)
      allow delete: if isGroupMember(groupId);
      
      // Transactions subcollection
      match /transactions/{txId} {
        // Group members can read all transactions (privacy filtering done in app)
        allow read: if isGroupMember(groupId);
        
        // Group members can create transactions
        allow create: if isGroupMember(groupId) && 
                         isValidTransaction() &&
                         request.resource.data.paidBy == request.auth.uid;
        
        // Only transaction creator can update/delete
        allow update, delete: if isGroupMember(groupId) && 
                                 resource.data.paidBy == request.auth.uid;
      }
      
      // Goals subcollection
      match /goals/{goalId} {
        // Group members can read all goals
        allow read: if isGroupMember(groupId);
        
        // Group members can create goals
        allow create: if isGroupMember(groupId) && isValidGoal();
        
        // Group members can update goals (contributions, progress)
        allow update: if isGroupMember(groupId) && 
                         isValidGoal() &&
                         // Cannot reduce target below current amount
                         request.resource.data.targetAmount >= request.resource.data.currentAmount;
        
        // Group members can delete goals
        allow delete: if isGroupMember(groupId);
      }
      
      // Debts subcollection
      match /debts/{debtId} {
        // Group members can read all debts
        allow read: if isGroupMember(groupId);
        
        // Group members can create debts
        allow create: if isGroupMember(groupId) && isValidDebt();
        
        // Group members can update debts (payments, balance changes)
        allow update: if isGroupMember(groupId) && isValidDebt();
        
        // Group members can delete debts
        allow delete: if isGroupMember(groupId);
      }
      
      // Budgets subcollection
      match /budgets/{budgetId} {
        // Group members can read all budgets
        allow read: if isGroupMember(groupId);
        
        // Group members can create/update budgets
        allow create, update: if isGroupMember(groupId) &&
                                 request.resource.data.limit is number &&
                                 request.resource.data.limit > 0;
        
        // Group members can delete budgets
        allow delete: if isGroupMember(groupId);
      }
      
      // Reports subcollection (AI-generated)
      match /reports/{reportId} {
        // Group members can read reports
        allow read: if isGroupMember(groupId);
        
        // Only Cloud Functions can write reports (not users directly)
        // This is enforced by not having an allow write rule
        // Cloud Functions use Admin SDK which bypasses security rules
      }
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
